# JDBC

---

### ЦЕЛИ ЭКЗАМЕНА OCP, ОПИСАННЫЕ В ЭТОЙ ГЛАВЕ:

#### Доступ к базам данных с помощью JDBC

+ Создавайте соединения, создавайте и выполняйте базовые, подготовленные и вызываемые операторы, обрабатывайте 
результаты запросов и управляйте транзакциями с помощью JDBC API.

---

JDBC означает подключение к базе данных Java. Эта глава познакомит вас с основами доступа к базам данных из Java. Мы 
рассмотрим ключевые интерфейсы для подключения, выполнения запросов, обработки результатов и работы с транзакциями.

Если вы новичок в JDBC, обратите внимание, что в этой главе рассматриваются только основы JDBC и работа с базами данных. 
Того, что мы проходим, достаточно для экзамена. Чтобы быть готовым использовать JDBC в работе, мы рекомендуем вам 
прочитать книги по SQL, а также по Java и базам данных. Например, вы можете попробовать SQL для чайников, 9-е издание 
Аллена Г. Тейлора (Wiley, 2018) и «Практическое программирование баз данных на Java» Ин Бай (Wiley-IEEE Press, 2011).

---

**Для опытных разработчиков**

Если вы опытный разработчик и хорошо знаете JDBC, вы можете пропустить раздел «Введение в реляционные базы данных и 
SQL». Однако внимательно прочитайте остальную часть этой главы. Мы обнаружили, что экзамен охватывает некоторые темы, 
которые разработчики не используют на практике, в частности:

+ Вероятно, вы настроили URL-адрес один раз для проекта для конкретной базы данных. Часто разработчики просто копируют 
и вставляют его откуда-то еще. Для экзамена вы должны понять это, а не полагаться на поиск.
+ Вероятно, вы используете DataSource. Для экзамена вам придется вспомнить или заново изучить, как работает DriverManager.

---

## Знакомство с реляционными базами данных и SQL

Данные — это информация. Часть данных — это один факт, например ваше имя. База данных — это организованный набор данных. 
В реальном мире картотека — это разновидность базы данных. В нем есть папки с файлами, в каждой из которых лежат 
листочки бумаги. Папки с файлами организованы определенным образом, часто в алфавитном порядке. Каждый листок бумаги 
подобен фрагменту данных. Точно так же папки на вашем компьютере подобны базе данных. Папки обеспечивают организацию, 
а каждый файл представляет собой часть данных.

Реляционная база данных — это база данных, организованная в таблицы, состоящие из строк и столбцов. Вы можете думать о 
таблице как о электронной таблице. Существует два основных способа доступа к реляционной базе данных из Java:

+ Подключение к базе данных Java (JDBC): доступ к данным в виде строк и столбцов. JDBC — это API, описанный в этой главе.
+ Java Persistence API (JPA): доступ к данным через объекты Java, используя концепцию, называемую объектно-реляционным 
сопоставлением (ORM). Идея состоит в том, что вам не нужно писать так много кода, и вы получаете данные в объектах Java. 
JPA не входит в экзамен, поэтому он не рассматривается в этой главе.

Доступ к реляционной базе данных осуществляется через язык структурированных запросов (SQL). SQL — это язык 
программирования, используемый для взаимодействия с записями базы данных. JDBC работает, отправляя команду SQL в базу 
данных и затем обрабатывая ответ.

Помимо реляционных баз данных, существует еще один тип баз данных, называемый базой данных NoSQL. Эти базы данных хранят 
свои данные в формате, отличном от таблиц, например ключ-значение, хранилища документов и базы данных на основе графов. 
NoSQL также выходит за рамки экзамена.

В следующих разделах мы представим небольшую реляционную базу данных, которую мы будем использовать для примеров в этой 
главе, и представим SQL для доступа к ней. Мы также рассмотрим некоторую лексику, которую вам необходимо знать.

---

**Выполнение примеров из главы**

В большинстве глав этой книги вам придется писать код и пробовать множество примеров. Эта глава другая. По-прежнему 
приятно попробовать примеры, но вы, вероятно, сможете правильно ответить на вопросы JDBC на экзамене, просто прочитав 
эту главу и освоив контрольные вопросы.

Хотя экзамен не зависит от базы данных, нам пришлось использовать базу данных для примеров, и мы выбрали базу данных 
HyperSQL. Это небольшая база данных в памяти. Фактически, для его запуска вам понадобится только один JAR-файл. Для 
реальных проектов нам нравятся MySQL и PostgreSQL.

Инструкции по загрузке и настройке базы данных для примеров в главе находятся в:

```
www.selikoff.net/ocp17
```

На данный момент вам не нужно разбираться ни в каком коде на веб-сайте. Это просто для того, чтобы вас настроить. 
Короче говоря, он подключается к базе данных и создает две таблицы. К концу этой главы вы должны понять, как таким 
образом создать Connection и ReadedStatement.

Существует множество руководств по установке и началу работы с любым из них. Настройка базы данных выходит за рамки 
книги и экзамена, но не стесняйтесь задавать вопросы в разделе базы данных/JDBC на CodeRanch. Возможно, вы даже 
получите ответ от авторов.

---

### Определение структуры реляционной базы данных

В нашей примерной базе данных есть две таблицы. В одном есть ряд для каждого вида, который есть в нашем зоопарке. 
В другом есть ряд для каждого животного. Эти два связаны друг с другом, потому что животное принадлежит к виду. 
Эти отношения являются причиной того, что этот тип базы данных называется реляционной базой данных. На рисунке 15.1 
показана структура нашей базы данных.

#### Рис. 15.1 - Таблицы в нашей реляционной базе данных


Как вы можете видеть на рисунке 15.1, у нас есть две таблицы. Один назван exhibits, а другой назван names. Каждая 
таблица имеет первичный ключ, который дает нам уникальный способ ссылки на каждую строку. В конце концов, у двух 
животных может быть одно и то же имя, но у них не может быть одного и того же идентификатора. Вам не нужно знать ключи 
к экзамену. Мы упоминаем их, чтобы дать вам немного контекста. В нашем примере так получилось, что первичным ключом 
является только один столбец. В некоторых ситуациях это комбинация столбцов, называемая составным ключом. Например, 
идентификатор студента и год могут быть составным ключом.

В таблице exhibits две строки и три столбца, а в таблице names — пять строк и три столбца. Для экзамена вам необходимо 
знать о строках и столбцах.

### Написание базовых операторов SQL

Самое главное, что вам нужно знать о SQL для экзамена, это то, что существует четыре типа операторов для работы с 
данными в таблицах. Они называются CRUD (Создание, Чтение, Обновление, Удаление). Ключевые слова SQL не соответствуют 
аббревиатуре, поэтому обратите внимание на ключевое слово SQL для каждого из них в таблице 15.1.

#### Таблица 15.1 - CRUD-операции

| Операция | Ключевое слово SQL |                   Описание                   |  
|:--------:|:------------------:|:--------------------------------------------:|
| Создать  |       INSERT       |       Добавляет новую строку в таблицу       |
|  Читать  |       SELECT       |          Получает данные из таблицы          |
| Обновить |       UPDATE       | Изменяет ноль или несколько строк в таблице  |
| Удалить  |      DELETE        | Удаляет ноль или несколько строк из таблицы  |

Вот и все. От вас не требуется определять корректность операторов SQL. От вас не ожидается обнаружения синтаксических 
ошибок в операторах SQL. От вас не требуется писать операторы SQL. Обратили внимание на тему?

В отличие от Java, ключевые слова SQL нечувствительны к регистру. Это означает, что select, SELECT и Select эквивалентны. 
Подобно примитивным типам Java, SQL имеет несколько типов данных. Большинство из них говорят сами за себя, например 
INTEGER. Еще есть DECIMAL, который в Java во многом похож на оператор double. Самым странным является VARCHAR, что 
означает «переменный символ», который похож на String в Java. Переменная part означает, что база данных должна 
использовать ровно столько места, сколько ей необходимо для хранения значения.

Хотя вам не обязательно знать, как их писать, мы приводим основные четыре инструкции SQL в таблице 15.2, поскольку они 
встречаются во многих вопросах.

#### Таблица 15.2 - SQL

|                                    Ключевое слово SQL                                     |                                                                                                                                                 Объяснение                                                                                                                                                 |  
|:-----------------------------------------------------------------------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|               INSERT INTO exhibits <br/> VALUES (3, 'Asian Elephant', 7.5);               |                                                                                      Добавляет новую строку с указанными значениями. По умолчанию используется порядок, в котором столбцы были определены в таблице.                                                                                       | 
|                        SELECT * FROM exhibits <br/> WHERE ID = 3;                         | Считывает данные из таблицы с необязательным предложением WHERE для ограничения возвращаемых данных. В SELECT можно использовать * для возврата всех столбцов, перечислять определенные столбцы для возврата или даже вызывать функции, такие как COUNT(*), чтобы возвращать количество совпадающих строк. |
| UPDATE exhibits <br/> SET num_acres = num_acres + .5 <br/> WHERE name = 'Asian Elephant'; |                                                                                              Устанавливает значение столбца с помощью необязательного предложения WHERE, чтобы ограничить обновляемые строки.                                                                                              |
|                DELETE FROM exhibits <br/> WHERE name = 'Asian Elephant';                  |                                                                                                     Удаляет строки с необязательным предложением WHERE, чтобы ограничить количество удаляемых строк.                                                                                                       |

## Знакомство с интерфейсами JDBC

Для сдачи экзамена вам необходимо знать пять ключевых интерфейсов JDBC. Интерфейсы объявлены в JDK. Они такие же, как и 
все другие интерфейсы и классы, которые вы видели в этой книге. Например, в главе 9 «Коллекции и обобщения» вы работали 
с интерфейсом List и конкретным классом ArrayList.

В JDBC конкретные классы берутся из драйвера JDBC. Каждая база данных имеет отдельный файл JAR с этими классами. 
Например, JAR PostgreSQL называется примерно так: postgresql-9.4–1201.jdbc4.jar. JAR MySQL называется примерно так: 
mysql-connector-java-5.1.36.jar. Точное имя зависит от производителя и версии JAR драйвера.

Этот JAR-файл драйвера содержит реализацию этих ключевых интерфейсов, а также ряда других интерфейсов. Ключевым 
моментом является то, что предоставленные реализации знают, как взаимодействовать с базой данных. Существуют также 
разные типы драйверов; к счастью, вам не нужно знать об этом на экзамене.

На рисунке 15.2 показаны пять ключевых интерфейсов, которые вам необходимо знать. Это также показывает, что реализация 
обеспечивается воображаемым JAR-файлом драйвера Foo. Они ловко прикрепляют имя Foo во всех классах.

Вы, наверное, заметили, что мы не сказали вам, как называются реализующие классы в любой реальной базе данных. Главное, 
что вы не должны этого знать. Используя JDBC, вы используете только интерфейсы в своем коде и никогда непосредственно 
не используете классы реализации. Фактически, они могут даже не быть публичными классами.

Что делают эти пять интерфейсов? На очень высоком уровне мы имеем следующее:

+ Driver: Устанавливает соединение с базой данных
+ Connection: Отправляет команды в базу данных
+ PreparedStatement: Выполняет SQL-запрос
+ CallableStatement: Выполняет команды, хранящиеся в базе данных.
+ ResultSet: Читает результаты запроса

#### Рис. 15.2 - Ключевые интерфейсы JDBC


Все интерфейсы базы данных находятся в пакете java.sql, поэтому в этой главе мы часто опускаем импорт.

В следующем примере мы покажем вам, как выглядит код JDBC, от начала до конца. Если вы новичок в JDBC, обратите 
внимание, что три из пяти интерфейсов присутствуют в коде. Если у вас есть опыт, помните, что на экзамене используется 
класс DriverManager вместо интерфейса DataSource.

```
public class MyFirstDatabaseConnection {
   public static void main(String[] args) throws SQLException {
      String url = "jdbc:hsqldb:file:zoo";
      try (Connection conn = DriverManager.getConnection(url);
         PreparedStatement ps = conn.prepareStatement(
            "SELECT name FROM exhibits");
         ResultSet rs = ps.executeQuery()) {
         while (rs.next())
            System.out.println(rs.getString(1));
   }   }   }
```

Если бы URL-адрес использовал наш воображаемый драйвер Foo, DriverManager вернул бы экземпляр FooConnection. Вызов метода 
prepareStatement() затем вернет экземпляр FooPreparedStatement, а вызов метода executeQuery() вернет экземпляр 
FooResultSet. Поскольку вместо этого URL-адрес использует hsqldb, он возвращает реализации, предоставленные HyperSQL для 
этих интерфейсов. Вам не обязательно знать их имена. В оставшейся части главы мы объясним, как использовать все пять 
интерфейсов, и более подробно расскажем о том, что они делают. К концу главы вы сами будете писать подобный код.

---

**Компиляция с модулями**

Почти все пакеты на экзамене находятся в модуле java.base. Как вы, возможно, помните из главы 12 «Модули», этот модуль 
включается автоматически, когда вы запускаете приложение в качестве модуля.

Напротив, все классы JDBC находятся в модуле java.sql. Они также находятся в пакете java.sql. Имена одинаковые, поэтому 
их легко запомнить. При работе с SQL вам понадобится модуль java.sql и импортируйте java.sql.*.

Мы рекомендуем разделить обучение JDBC и модулям. Вы можете использовать путь к классам при работе с JDBC и 
зарезервировать свою практику с путем к модулю для изучения модулей.

Тем не менее, если вы хотите использовать код JDBC с модулями, не забудьте обновить файл module-info, включив в него 
следующее:

```
requires java.sql;
```

---

## Подключение к базе данных

Первым шагом при работе с базой данных является подключение к ней. Сначала мы покажем вам, как создать URL-адрес JDBC. 
Затем мы покажем вам, как использовать его для подключения к базе данных.

### Создание URL-адреса JDBC

Чтобы получить доступ к веб-сайту, вам необходимо знать его URL. Чтобы получить доступ к электронной почте, вам 
необходимо знать свое имя пользователя и пароль. JDBC ничем не отличается. Чтобы получить доступ к базе данных, вам 
необходимо знать эту информацию о ней.

В отличие от веб-URL-адресов, URL-адреса JDBC имеют различные форматы. У них есть три общие части, как показано на 
рисунке 15.3. Первая часть всегда одна и та же. Это протокол jdbc. Вторая часть — это подпротокол, представляющий собой 
имя базы данных, например hsqldb, mysql или postgres. Третья часть — это подимя, которое представляет собой формат, 
специфичный для базы данных. Двоеточие (:) разделяет три части.

Подимя обычно содержит информацию о базе данных, такую как ее местоположение и/или имя. Синтаксис варьируется. Вам нужно 
знать о трех основных частях. Вам не нужно запоминать форматы подимен. Фух! Вы уже видели один такой URL:

```
jdbc:hsqldb:file:zoo
```

#### Рис. 15.3 - Формат URL-адреса JDBC


Обратите внимание на три части. Он начинается с jdbc, а затем идет подпротокол hsqldb. Оно заканчивается подименем, 
которое говорит нам, что мы используем файловую систему. В этом случае местоположение является именем базы данных.

Другие примеры подимен показаны здесь:

```
jdbc:postgresql://localhost/zoo
jdbc:oracle:thin:@123.123.123.123:1521:zoo
jdbc:mysql://localhost:3306
jdbc:mysql://localhost:3306/zoo?profileSQL=true
```

Вы можете видеть, что каждый из этих URL-адресов JDBC начинается с jdbc, за которым следует двоеточие, а затем имя 
поставщика/продукта. После этого URL-адреса меняются. Обратите внимание, что все они включают расположение базы данных: 
localhost, 123.123.123.123:1521 и localhost:3306. Также обратите внимание, что порт не является обязательным при 
использовании местоположения по умолчанию.

### Getting a Database Connection 937